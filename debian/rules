#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1
export DEB_BUILD_MAINT_OPTIONS=hardening=-format
export DEB_BUILD_HARDENING_FORMAT=0


# This has to be exported to make some magic below work.
export DH_OPTIONS

IS_SYSTEMD = $(shell command -v dh_systemd_enable > /dev/null 2>&1 && echo true)

%:
	dh $@ --buildsystem=cmake --builddirectory=build --parallel

override_dh_clean:
	dh_clean
	rm -f debian/knxd.install

override_dh_auto_configure:
	dh_auto_configure -- -DCMAKE_INSTALL_LIBEXECDIR=lib \
    -DENABLE_USB=ON -DENABLE_GROUPCACHE=ON -DENABLE_FT12=ON -DENABLE_TPUART=ON -DENABLE_DUMMY=ON

override_dh_install: debian/knxd.install
	dh_install
	dh_systemd_enable || true
	dh_systemd_start || true

#override_dh_installudev: debian/knxd.udev
#	# install the udev file to /etc since it needs to be modified
#	mkdir -p debian/knxd/usr/share/doc/knxd/examples
#	install debian/knxd.udev debian/knxd/usr/share/doc/knxd/examples/70-knxd.rules.sample

override_dh_compress:
	dh_compress -X.rst

override_dh_installinit:
ifeq (false, $(IS_SYSTEMD))
	dh_installinit
endif

debian/knxd.install: debian/knxd.install.in
	cp $^ $@
ifeq (true, $(IS_SYSTEMD))
	cat $@.systemd >> $@
endif

#override_dh_auto_test:
	#bash tools/test.sh
